(function(window){window.webspeechkit={recorderInited:false,FORMAT:{PCM8:{format:'pcm',samplerate:8000,mime:"audio/x-pcm;bit=16;rate=8000"},PCM16:{format:'pcm',samplerate:16000,mime:"audio/x-pcm;bit=16;rate=16000"},PCM44:{format:'pcm',samplerate:44100,mime:"audio/x-pcm;bit=16;rate=44100"},SPEEX8:{format:'speex',samplerate:8000,mime:"audio/x-speex"},SPEEX16:{format:'speex',samplerate:16000,mime:"audio/x-speex"}}};var scriptPath=function(){var scripts=document.getElementsByTagName('script');var path='';if(scripts&&scripts.length>0){for(var i in scripts){if(scripts[i].src&&scripts[i].src.match(/\/webspeechkit.min.js$/)){path=scripts[i].src.replace(/(.*)\/webspeechkit.min.js$/,'$1');break;}}}
return path;};var WORKER_PATH=scriptPath()+'/webspeechkitWorker.min.js';function Recorder(stream)
{return function(bufferSize,channelCount,onError,workerPath,outSampleRate)
{var backref=this;this.bufferLen=bufferSize||4096;this.channelCount=Math.max(1,Math.min(channelCount||2,2)); this.context=new AudioContext();this.outSampleRate=outSampleRate||this.context.sampleRate
if(this.outSampleRate==this.context.sampleRate)
this.inputPoint=this.context.createGain();else{this.inputPoint=this.context.createBiquadFilter();this.inputPoint.type="lowpass";this.inputPoint.frequency.value=this.outSampleRate;this.inputPoint.Q.value=1;this.inputPoint.gain.value=5;}
this.audioInput=this.context.createMediaStreamSource(stream);this.audioInput.connect(this.inputPoint);if(!this.context.createScriptProcessor){this.node=this.context.createJavaScriptNode(this.bufferLen,2,this.channelCount);}else{this.node=this.context.createScriptProcessor(this.bufferLen,2,this.channelCount);}
var worker=new Worker(workerPath||WORKER_PATH);var recording=false;var currCallback;var buffCallback;var startCallback;this.node.onaudioprocess=function(e){if(!recording)return;worker.postMessage({command:'record',buffer:[e.inputBuffer.getChannelData(0),e.inputBuffer.getChannelData(1)]});}
this.getAudioContext=function(){return this.context;}
this.getAnalyserNode=function(){var analyserNode=this.context.createAnalyser();analyserNode.fftSize=2048;this.inputPoint.connect(analyserNode);return analyserNode;}
this.start=function(cb,format){startCallback=cb;worker.postMessage({command:'init',config:{sampleRate:this.context.sampleRate,format:format,bufSize:this.bufferLen}});this.clear(function(){recording=true;});}
this.stop=function(cb){recording=false;this.exportWAV(function(blob)
{cb(blob);});}
this.isRecording=function(){return recording;}
this.clear=function(cb){currCallback=cb;worker.postMessage({command:'clear'});}
this.getBuffers=function(cb){buffCallback=cb;worker.postMessage({command:'getBuffers'})}
this.exportWAV=function(cb,type){currCallback=cb;type=type||'audio/wav';if(!currCallback)throw new Error('Callback not set');worker.postMessage({command:"export"+(this.channelCount!=2&&"Mono"||"")+"WAV",type:type});}
worker.onmessage=function(e){if(e.data.command=='int16stream')
{var data=e.data.buffer;if(startCallback){startCallback(data);}}
else if(e.data.command=='getBuffers'&&buffCallback)
{buffCallback(e.data.blob)}
else if(e.data.command=='clear'&&currCallback)
{currCallback();}
else if(currCallback)
{currCallback(e.data.blob);}}
this.inputPoint.connect(this.node);this.node.connect(this.context.destination);}}
window.webspeechkit.initRecorder=function(initSuccess,initFail)
{window.AudioContext=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=(navigator.getUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.webkitGetUserMedia);window.webspeechkit.Recorder=null;var badInitialization=function(err){window.webspeechkit.recorderInited=false;window.webspeechkit.Recorder=function()
{return null;}
initFail(err);}
if(navigator.getUserMedia)
{navigator.getUserMedia({audio:true},function(stream){window.webspeechkit.Recorder=Recorder(stream);window.webspeechkit.recorderInited=true;initSuccess();},function(err){badInitialization(err);});}
else
{badInitialization("Your browser doesn't support WebRTC. Please, use Firefox or Yandex.Browser");}};})(window);window.webspeechkit.Recognizer=function(url,uuid,key,audioFormat,listener){var socket=new WebSocket(url);function sendRaw(data){socket.send(data);}
function sendJson(json){sendRaw(JSON.stringify({type:'message',data:json}));}
var sessionId=null;$(socket).bind('open',function(){sendJson({uuid:uuid,key:key,format:audioFormat});}).bind('message',function(e){var message=JSON.parse(e.originalEvent.data)
if(message.type=='InitResponse'){sessionId=message.data.sessionId;listener.onInit(message.data.sessionId,message.data.code)}
else if(message.type=="AddDataResponse"){listener.onResult(message.data.text,message.data.uttr,message.data.merge);}
else if(message.type=="Error"){console.log("Error from server "+message.data)
listener.onError(message.data)}
else{console.log("Unknown message format, receive this:"+message)
listener.onError(message)}})
var totaldata=0;this.addData=function(data){totaldata+=data.byteLength;if(!sessionId)
{console.log("Data ingored, session not yet inited.")
return;}
sendRaw(new Blob([data],{type:audioFormat}))}
this.close=function(){socket.close();}};window.webspeechkit.Dictation=function(asr_url,uuid,apikey){var backref=this;backref.send=0;backref.send_bytes=0;backref.proc=0;backref.bufsize=1024;backref.webSocketPath=function(){if((asr_url.indexOf("wss://")==0)||(asr_url.indexOf("ws://")==0))
return asr_url;var loc=window.location,new_uri;if(loc.protocol==="https:"){new_uri="wss:";}else{new_uri="ws:";}
new_uri+="//";new_uri+=asr_url;return new_uri;}
backref.start=function(format,initCallback,errorCallback,dataCallback,infoCallback){if(webspeechkit.recorderInited){backref.onstart(format,initCallback,errorCallback,dataCallback,infoCallback);}
else{webspeechkit.initRecorder(function(){backref.onstart(format,initCallback,errorCallback,dataCallback,infoCallback);},function(err){errorCallback("Could not init AudioContext: "+err);})}}
backref.onstart=function(format,initCallback,errorCallback,dataCallback,infoCallback){format=format||webspeechkit.FORMAT.PCM16;backref.send=0;backref.send_bytes=0;backref.proc=0;backref.recorder=new webspeechkit.Recorder(backref.bufsize,1,function(){errorCallback("Failed to create Recorder");},null,format.samplerate);backref.recognizer=new webspeechkit.Recognizer(backref.webSocketPath(),uuid,apikey,format.mime,{onInit:function(sessionId,code){initCallback(sessionId,code);backref.recorder.start(function(data){backref.send++;backref.send_bytes+=data.byteLength;infoCallback({send_bytes:backref.send_bytes,format:format,send_packages:backref.send,processed:backref.proc});backref.recognizer.addData(data);},format)},onResult:function(text,uttr,merge){backref.proc+=merge;dataCallback(text,uttr,merge);},onError:function(msg){backref.recorder.stop(function(){});errorCallback(msg);}});};backref.stop=function(){backref.recorder.stop(function(){backref.recognizer.close()});};};
